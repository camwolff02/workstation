#!/usr/bin/env bash
set -euo pipefail

ROOT="/etc/systemd/system"
CFG="$(dirname "$0")/../services/config.sh"

apply() {
  source "$CFG"

  # tailscale-up
  if [[ "${ENABLE_TAILSCALE:-false}" == "true" ]]; then
    systemctl enable --now tailscaled.service
    systemctl enable --now tailscale-up.service
  else
    systemctl disable --now tailscale-up.service || true
  fi

  # headless Xorg
  if [[ "${ENABLE_XORG_VIRTUAL:-false}" == "true" ]]; then
    systemctl enable --now xorg-virtual-display.service
  else
    systemctl disable --now xorg-virtual-display.service || true
  fi

  # sunshine (depends on Xorg running)
  if [[ "${ENABLE_SUNSHINE:-false}" == "true" ]]; then
    systemctl enable --now sunshine.service
  else
    systemctl disable --now sunshine.service || true
  fi
}

case "${1:-}" in
  apply) apply ;;
  enable) sed -i "s/ENABLE_${2^^}=false/ENABLE_${2^^}=true/" "$CFG"; apply ;;
  disable) sed -i "s/ENABLE_${2^^}=true/ENABLE_${2^^}=false/" "$CFG"; apply ;;
  list) cat "$CFG" ;;
  help) print_help ;;
  *) print_help; exit 1 ;;
esac

print_help() {
  cat <<'EOF'
Usage: svc {apply|enable <NAME>|disable <NAME>|list|help}

Names you can toggle:
  - TAILSCALE
  - XORG_VIRTUAL
  - SUNSHINE

Examples:
  svc list
  sudo svc enable SUNSHINE
  sudo svc disable XORG_VIRTUAL
  sudo svc apply
EOF
}

