- name: Init facts for Ookla repo
  set_fact:
    deb_arch: >-
      {{ 'amd64' if ansible_architecture == 'x86_64'
         else 'arm64' if ansible_architecture in ['aarch64','arm64']
         else ansible_architecture }}
    # Use Jammy on Noble until Ookla publishes a Noble Release file
    ookla_repo_release: >-
      {{ 'jammy' if (ansible_distribution == 'Ubuntu' and ansible_distribution_release == 'noble')
         else ansible_distribution_release }}

- name: Ensure prerequisites (curl, gpg, https transport)
  apt:
    name:
      - curl
      - gnupg
      - apt-transport-https
    state: present
    update_cache: true

- name: Ensure /etc/apt/keyrings exists
  file:
    path: /etc/apt/keyrings
    state: directory
    mode: "0755"

- name: Fetch Ookla Packagecloud GPG key
  get_url:
    url: https://packagecloud.io/ookla/speedtest-cli/gpgkey
    dest: /etc/apt/keyrings/ookla_speedtest-cli.asc
    mode: "0644"

- name: De-armor GPG key to keyring
  command: >
    gpg --dearmor -o /etc/apt/keyrings/ookla_speedtest-cli-archive-keyring.gpg
    /etc/apt/keyrings/ookla_speedtest-cli.asc
  args:
    creates: /etc/apt/keyrings/ookla_speedtest-cli-archive-keyring.gpg

# If the Packagecloud script previously created a broken "noble" entry, remove it
- name: Remove old/broken Ookla source file if present
  file:
    path: /etc/apt/sources.list.d/ookla_speedtest-cli.list
    state: absent

- name: Add Ookla APT repository (Jammy on Noble; otherwise native release)
  apt_repository:
    repo: >-
      deb [arch={{ deb_arch }} signed-by=/etc/apt/keyrings/ookla_speedtest-cli-archive-keyring.gpg]
      https://packagecloud.io/ookla/speedtest-cli/ubuntu/ {{ ookla_repo_release }} main
    state: present
    filename: ookla_speedtest-cli

- name: Install Ookla Speedtest CLI
  apt:
    name: speedtest
    state: present
    update_cache: true

- name: Show installed version
  command: speedtest --version
  register: speedtest_version
  changed_when: false

- name: Print version
  debug:
    msg: "{{ speedtest_version.stdout }}"
