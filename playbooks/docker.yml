# 1) Install Docker Engine + Compose plugin (official Docker repo)
- name: Ensure required packages are installed
  apt:
    name:
      - ca-certificates
      - curl
      - gnupg
    state: present
    update_cache: true

- name: Ensure keyrings directory exists (for Docker)
  ansible.builtin.command:
    cmd: install -m 0755 -d /etc/apt/keyrings
  args:
    creates: /etc/apt/keyrings

- name: Download Docker GPG key
  ansible.builtin.get_url:
    url: https://download.docker.com/linux/ubuntu/gpg
    dest: /etc/apt/keyrings/docker.asc
    mode: '0644'

- name: Add Docker repository
  apt_repository:
    repo: "deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
    state: present
    filename: docker

- name: Install Docker Engine, CLI, Buildx, and Compose plugin
  apt:
    name:
      - docker-ce
      - docker-ce-cli
      - containerd.io
      - docker-buildx-plugin
      - docker-compose-plugin
    state: present
    update_cache: true

# 2) Allow running Docker without sudo (post-install)
- name: Ensure docker group exists
  group:
    name: docker
    state: present

- name: Add current user to docker group
  user:
    name: "{{ ansible_user | default(ansible_env.SUDO_USER) | default(ansible_env.USER) }}"
    groups: docker
    append: true

- name: Reset SSH connection to apply new group membership
  meta: reset_connection

# 3) OPTIONAL: Install NVIDIA Container Toolkit when an NVIDIA GPU is detected
- name: Ensure pciutils is installed (for GPU detection)
  apt:
    name: pciutils
    state: present

- name: Detect NVIDIA GPU presence (PCI vendor 10de)
  command: lspci -nnd 10de
  register: nvidia_lspci
  changed_when: false
  failed_when: false

- name: Flag if an NVIDIA GPU is present
  set_fact:
    nvidia_gpu_present: "{{ (nvidia_lspci.stdout | default('') | trim) != '' }}"

- name: Install NVIDIA Container Toolkit when NVIDIA GPU is detected
  when: nvidia_gpu_present
  tags: ['nvidia', 'gpu']
  block:
    - name: Fetch NVIDIA libnvidia-container repository key (ASCII)
      get_url:
        url: https://nvidia.github.io/libnvidia-container/gpgkey
        dest: /usr/share/keyrings/nvidia-container-toolkit.asc
        mode: '0644'

    - name: De-armor NVIDIA repo key
      command: >
        gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg
        /usr/share/keyrings/nvidia-container-toolkit.asc
      args:
        creates: /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg

    - name: Add NVIDIA libnvidia-container APT source list (stable)
      get_url:
        url: https://nvidia.github.io/libnvidia-container/stable/deb/nvidia-container-toolkit.list
        dest: /etc/apt/sources.list.d/nvidia-container-toolkit.list
        mode: '0644'

    - name: Ensure NVIDIA APT source uses signed-by keyring
      replace:
        path: /etc/apt/sources.list.d/nvidia-container-toolkit.list
        regexp: '^deb https://'
        replace: 'deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://'

    - name: Install NVIDIA Container Toolkit packages
      apt:
        name: nvidia-container-toolkit
        state: present
        update_cache: true

    - name: Configure Docker to use the NVIDIA Container Runtime
      command: nvidia-ctk runtime configure --runtime=docker

    - name: Restart Docker to apply NVIDIA runtime changes
      systemd:
        name: docker
        state: restarted
        enabled: true

